@page "/heatmap"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Confidence Heatmap</PageTitle>

<h2>Confidence Heatmap</h2>
<p class="subtitle">Y = Intent, X = Zaman, renk = confidence.</p>

<div class="dashboard-toolbar">
    <label>Entity ID <input @bind="_entityId" placeholder="IntentumSampleWeb" /></label>
    <label>From <input type="datetime-local" @bind="_from" /></label>
    <label>To <input type="datetime-local" @bind="_to" /></label>
    <button type="button" @onclick="LoadHeatmap">Yükle</button>
</div>

@if (_loading)
{
    <p class="muted">Yükleniyor…</p>
}
@if (_error != null)
{
    <p class="error">@_error</p>
}
<div id="heatmap-chart" style="width: 100%; height: 400px;"></div>

@code {
    private string _entityId = "IntentumSampleWeb";
    private DateTime _from = DateTime.UtcNow.AddDays(-7);
    private DateTime _to = DateTime.UtcNow;
    private bool _loading = true;
    private string? _error;
    private EChartsInterop? _echarts;
    private const string ChartId = "heatmap-chart";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _echarts = new EChartsInterop(JSRuntime, ChartId);
            await _echarts.InitAsync();
            await SetDefaultDates();
            await LoadHeatmap();
        }
    }

    private async Task SetDefaultDates()
    {
        var to = DateTimeOffset.UtcNow;
        var from = to.AddDays(-7);
        _to = to.UtcDateTime;
        _from = from.UtcDateTime;
        await Task.CompletedTask;
    }

    private async Task LoadHeatmap()
    {
        _loading = true;
        _error = null;
        StateHasChanged();
        try
        {
            var from = new DateTimeOffset(_from.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_from, DateTimeKind.Utc) : _from);
            var to = new DateTimeOffset(_to.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_to, DateTimeKind.Utc) : _to);
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            var url = $"{baseUri}/api/intent/analytics/timeline/{Uri.EscapeDataString(_entityId)}?from={Uri.EscapeDataString(from.ToString("o"))}&to={Uri.EscapeDataString(to.ToString("o"))}";
            var timeline = await Http.GetFromJsonAsync<TimelineResponse>(url);
            if (timeline?.Points != null && timeline.Points.Count > 0)
            {
                var intents = timeline.Points.Select(p => p.IntentName).Distinct(StringComparer.OrdinalIgnoreCase).OrderBy(x => x).ToList();
                var intentIndex = intents.Select((name, i) => (name, i)).ToDictionary(x => x.name, x => x.i, StringComparer.OrdinalIgnoreCase);
                var heatmapData = timeline.Points
                    .OrderBy(p => p.RecordedAt)
                    .Select(p => new object[] { p.RecordedAt.ToUnixTimeMilliseconds(), intentIndex.GetValueOrDefault(p.IntentName, 0), Math.Round(p.ConfidenceScore, 4) })
                    .ToList();
                var option = new
                {
                    tooltip = new { position = "top" },
                    grid = new { height = "60%", top = "10%" },
                    xAxis = new { type = "time", splitArea = new { show = true } },
                    yAxis = new { type = "category", data = intents, splitArea = new { show = true } },
                    visualMap = new
                    {
                        min = 0,
                        max = 1,
                        calculable = true,
                        orient = "horizontal",
                        left = "center",
                        bottom = "5%",
                        inRange = new { color = new[] { "#d32f2f", "#ffeb3b", "#4caf50" } }
                    },
                    series = new[] { new { name = "Confidence", type = "heatmap", data = heatmapData, label = new { show = false }, emphasis = new { itemStyle = new { shadowBlur = 10, shadowColor = "rgba(0,0,0,0.5)" } } } }
                };
                if (_echarts != null)
                    await _echarts.SetOptionAsync(option);
            }
            else if (_echarts != null)
            {
                await _echarts.SetOptionAsync(new { title = new { text = "Bu pencerede veri yok", left = "center" } });
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_echarts != null)
            await _echarts.DisposeAsync();
    }

    private sealed record TimelineResponse(string EntityId, DateTimeOffset Start, DateTimeOffset End, IReadOnlyList<TimelinePointDto>? Points);
    private sealed record TimelinePointDto(DateTimeOffset RecordedAt, string IntentName, double ConfidenceScore);
}
