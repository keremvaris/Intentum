@page "/signals"
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Signal Explorer</PageTitle>

<h2>Signal Explorer</h2>
<p class="subtitle">Intent'leri tetikleyen ham sinyaller.</p>

<div class="dashboard-toolbar">
    <label>Intent (filtre) <input @bind="_intentFilter" placeholder="boş = tümü" /></label>
    <label>From <input type="datetime-local" @bind="_from" /></label>
    <label>To <input type="datetime-local" @bind="_to" /></label>
    <label>Limit <input type="number" @bind="_limit" min="1" max="200" style="width:4rem" /></label>
    <button type="button" @onclick="LoadSignals">Yükle</button>
    <span class="export-links">
        <a href="@GetExportJsonUrl()" target="_blank" rel="noopener" class="export-link">JSON indir</a>
        <a href="@GetExportCsvUrl()" target="_blank" rel="noopener" class="export-link">CSV indir</a>
    </span>
</div>

@if (_loading)
{
    <p class="muted">Yükleniyor…</p>
}
else if (_error != null)
{
    <p class="error">@_error</p>
}
else
{
    <div class="table-wrap">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Intent</th>
                    <th>Zaman</th>
                    <th>Olay özeti</th>
                    <th>Güven</th>
                    <th>Karar</th>
                </tr>
            </thead>
            <tbody>
                @if (_signals?.Count > 0)
                {
                    @foreach (var s in _signals)
                    {
                        <tr>
                            <td><code>@s.Id</code></td>
                            <td>@s.IntentName</td>
                            <td>@s.RecordedAt.ToLocalTime().ToString("g")</td>
                            <td><span class="events-summary" title="@s.EventsSummary">@s.EventsSummary</span></td>
                            <td>@s.ConfidenceLevel (@s.ConfidenceScore.ToString("P0"))</td>
                            <td><span class="badge">@s.Decision</span></td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="6">Bu filtrede kayıt yok.</td></tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private string _intentFilter = "";
    private DateTime _from = DateTime.UtcNow.AddDays(-7);
    private DateTime _to = DateTime.UtcNow;
    private int _limit = 50;
    private bool _loading = true;
    private string? _error;
    private IReadOnlyList<SignalDto>? _signals;

    protected override async Task OnInitializedAsync()
    {
        await LoadSignals();
    }

    private string GetExportJsonUrl()
    {
        var from = new DateTimeOffset(_from.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_from, DateTimeKind.Utc) : _from);
        var to = new DateTimeOffset(_to.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_to, DateTimeKind.Utc) : _to);
        var origin = new Uri(Navigation.Uri).GetLeftPart(UriPartial.Authority);
        return $"{origin}/api/intent/analytics/export/json?from={Uri.EscapeDataString(from.ToString("o"))}&to={Uri.EscapeDataString(to.ToString("o"))}";
    }

    private string GetExportCsvUrl()
    {
        var from = new DateTimeOffset(_from.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_from, DateTimeKind.Utc) : _from);
        var to = new DateTimeOffset(_to.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_to, DateTimeKind.Utc) : _to);
        var origin = new Uri(Navigation.Uri).GetLeftPart(UriPartial.Authority);
        return $"{origin}/api/intent/analytics/export/csv?from={Uri.EscapeDataString(from.ToString("o"))}&to={Uri.EscapeDataString(to.ToString("o"))}";
    }

    private async Task LoadSignals()
    {
        _loading = true;
        _error = null;
        StateHasChanged();
        try
        {
            var from = new DateTimeOffset(_from.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_from, DateTimeKind.Utc) : _from);
            var to = new DateTimeOffset(_to.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(_to, DateTimeKind.Utc) : _to);
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            var query = $"?from={Uri.EscapeDataString(from.ToString("o"))}&to={Uri.EscapeDataString(to.ToString("o"))}&limit={_limit}";
            if (!string.IsNullOrWhiteSpace(_intentFilter))
                query += "&intent=" + Uri.EscapeDataString(_intentFilter.Trim());
            _signals = await Http.GetFromJsonAsync<List<SignalDto>>(baseUri + "/api/signals" + query);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private sealed record SignalDto(string Id, string IntentName, DateTimeOffset RecordedAt, string? EventsSummary, string ConfidenceLevel, string Decision, double ConfidenceScore);
}
