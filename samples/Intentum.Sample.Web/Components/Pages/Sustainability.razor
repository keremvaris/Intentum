@page "/sustainability"
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Sustainability</PageTitle>

<h2>Sustainability</h2>
<p class="subtitle">Greenwashing analizi ve Carbon rapor demo.</p>

<div class="explain-tabs">
    <button type="button" class="@(_tab == "greenwashing" ? "active" : "")" @onclick="@(() => _tab = "greenwashing")">Greenwashing</button>
    <button type="button" class="@(_tab == "carbon" ? "active" : "")" @onclick="@(() => _tab = "carbon")">Carbon</button>
</div>

@if (_tab == "greenwashing")
{
    <section class="sustainability-section">
        <h3 class="section-subtitle">Rapor metni analizi</h3>
        <p class="muted">Sürdürülebilirlik raporu metnini yapıştırın; analiz intent + karar + önerilen aksiyonlar döner.</p>
        <div class="dashboard-toolbar">
            <label>Rapor metni <textarea @bind="_reportText" rows="5" style="width: 100%; max-width: 500px;" placeholder="Örnek: Şirketimiz 2030'a kadar net sıfır taahhüt etmiştir. Scope 3 tedarikçi doğrulaması devam ediyor."></textarea></label>
            <label>Kaynak <select @bind="_sourceType"><option value="Report">Rapor</option><option value="PressRelease">Basın bülteni</option><option value="SocialMedia">Sosyal medya</option><option value="InvestorPresentation">Yatırımcı sunumu</option></select></label>
            <button type="button" @onclick="AnalyzeGreenwashing" disabled="@_loading">Analiz et</button>
        </div>
        @if (_loading && _tab == "greenwashing") { <p class="muted">Yükleniyor…</p> }
        @if (_greenError != null) { <p class="error">@_greenError</p> }
        @if (_greenResult != null)
        {
            <div class="card">
                <h4>Sonuç</h4>
                <p><strong>Intent:</strong> @_greenResult.IntentName</p>
                <p><strong>Güven:</strong> @_greenResult.Confidence (@_greenResult.ConfidenceScore.ToString("P0"))</p>
                <p><strong>Karar:</strong> <span class="badge">@_greenResult.Decision</span></p>
                @if (_greenResult.SuggestedActions?.Count > 0)
                {
                    <p><strong>Önerilen aksiyonlar:</strong></p>
                    <ul>
                        @foreach (var a in _greenResult.SuggestedActions)
                        { <li>@a</li> }
                    </ul>
                }
            </div>
        }
        <h3 class="section-subtitle">Son analizler</h3>
        <div class="table-wrap">
            <table class="history-table">
                <thead><tr><th>Önizleme</th><th>Intent</th><th>Karar</th><th>Kaynak</th><th>Tarih</th></tr></thead>
                <tbody>
                    @if (_recentAnalyses?.Count > 0)
                    {
                        @foreach (var r in _recentAnalyses)
                        {
                            <tr data-id="@r.Id">
                                <td><span class="events-summary">@r.ReportPreview</span></td>
                                <td>@r.IntentName</td>
                                <td><span class="badge">@r.Decision</span></td>
                                <td>@(r.SourceType ?? "—")</td>
                                <td>@r.AnalyzedAt.ToLocalTime().ToString("g")</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="5">Henüz analiz yok.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </section>
}

@if (_tab == "carbon")
{
    <section class="sustainability-section">
        <h3 class="section-subtitle">Carbon rapor oluştur</h3>
        <p class="muted">Hesaplama tetikleyip rapor ID alın; raporu görüntüleyin.</p>
        <div class="dashboard-toolbar">
            <label>Actor <input @bind="_carbonActor" placeholder="Acme Corp" /></label>
            <label>Scope <input @bind="_carbonScope" placeholder="Scope1" /></label>
            <button type="button" @onclick="CalculateCarbon" disabled="@_loading">Hesapla</button>
        </div>
        @if (_loading && _tab == "carbon") { <p class="muted">Yükleniyor…</p> }
        @if (_carbonError != null) { <p class="error">@_carbonError</p> }
        @if (_carbonReportId != null)
        {
            <div class="card">
                <p><strong>Rapor ID:</strong> <code>@_carbonReportId</code></p>
                <button type="button" @onclick="LoadCarbonReport" disabled="@_loading">Raporu gör</button>
            </div>
        }
        @if (_carbonReport != null)
        {
            <div class="card">
                <h4>Rapor</h4>
                <p><strong>Başlık:</strong> @_carbonReport.Title</p>
                <p><strong>Güven:</strong> @_carbonReport.ConfidenceLevel</p>
                <p><strong>Oluşturulma:</strong> @_carbonReport.GeneratedAt.ToLocalTime().ToString("g")</p>
            </div>
        }
    </section>
}

@code {
    private string _tab = "greenwashing";
    private string _reportText = "";
    private string _sourceType = "Report";
    private string _carbonActor = "Acme Corp";
    private string _carbonScope = "Scope1";
    private bool _loading;
    private string? _greenError;
    private string? _carbonError;
    private GreenwashingResultDto? _greenResult;
    private string? _carbonReportId;
    private CarbonReportDto? _carbonReport;
    private IReadOnlyList<GreenwashingRecentDto>? _recentAnalyses;

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentGreenwashing();
    }

    private async Task LoadRecentGreenwashing()
    {
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            _recentAnalyses = await Http.GetFromJsonAsync<List<GreenwashingRecentDto>>(baseUri + "/api/greenwashing/recent?limit=15");
        }
        catch { _recentAnalyses = new List<GreenwashingRecentDto>(); }
        StateHasChanged();
    }

    private async Task AnalyzeGreenwashing()
    {
        _loading = true;
        _greenError = null;
        _greenResult = null;
        StateHasChanged();
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            var body = new { report = _reportText, sourceType = _sourceType, language = "TR" };
            var opts = new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase };
            var res = await Http.PostAsJsonAsync(baseUri + "/api/greenwashing/analyze", body, opts);
            res.EnsureSuccessStatusCode();
            _greenResult = await res.Content.ReadFromJsonAsync<GreenwashingResultDto>();
            await LoadRecentGreenwashing();
        }
        catch (Exception ex)
        {
            _greenError = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task CalculateCarbon()
    {
        _loading = true;
        _carbonError = null;
        _carbonReportId = null;
        _carbonReport = null;
        StateHasChanged();
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            var body = new { actor = _carbonActor, scope = _carbonScope };
            var opts = new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase };
            var res = await Http.PostAsJsonAsync(baseUri + "/api/carbon/calculate", body, opts);
            if (res.IsSuccessStatusCode)
            {
                var data = await res.Content.ReadFromJsonAsync<CarbonCalculateOkDto>();
                _carbonReportId = data?.ReportId?.ToString();
            }
            else
            {
                var err = await res.Content.ReadFromJsonAsync<CarbonCalculateErrorDto>();
                _carbonError = err?.Error ?? res.ReasonPhrase;
            }
        }
        catch (Exception ex)
        {
            _carbonError = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCarbonReport()
    {
        if (string.IsNullOrEmpty(_carbonReportId)) return;
        _loading = true;
        _carbonError = null;
        StateHasChanged();
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            _carbonReport = await Http.GetFromJsonAsync<CarbonReportDto>(baseUri + "/api/carbon/report/" + Uri.EscapeDataString(_carbonReportId));
            if (_carbonReport == null) _carbonError = "Rapor bulunamadı.";
        }
        catch (Exception ex)
        {
            _carbonError = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private sealed record GreenwashingResultDto(
        [property: JsonPropertyName("intentName")] string IntentName,
        [property: JsonPropertyName("confidence")] string Confidence,
        [property: JsonPropertyName("confidenceScore")] double ConfidenceScore,
        [property: JsonPropertyName("decision")] string Decision,
        [property: JsonPropertyName("suggestedActions")] IReadOnlyList<string>? SuggestedActions);
    private sealed record GreenwashingRecentDto(
        [property: JsonPropertyName("id")] string Id,
        [property: JsonPropertyName("reportPreview")] string ReportPreview,
        [property: JsonPropertyName("intentName")] string IntentName,
        [property: JsonPropertyName("decision")] string Decision,
        [property: JsonPropertyName("sourceType")] string? SourceType,
        [property: JsonPropertyName("analyzedAt")] DateTimeOffset AnalyzedAt);
    private sealed record CarbonCalculateOkDto([property: JsonPropertyName("reportId")] Guid? ReportId);
    private sealed record CarbonCalculateErrorDto([property: JsonPropertyName("error")] string? Error);
    private sealed record CarbonReportDto(
        [property: JsonPropertyName("reportId")] string ReportId,
        [property: JsonPropertyName("title")] string Title,
        [property: JsonPropertyName("confidenceLevel")] string ConfidenceLevel,
        [property: JsonPropertyName("generatedAt")] DateTime GeneratedAt);
}
