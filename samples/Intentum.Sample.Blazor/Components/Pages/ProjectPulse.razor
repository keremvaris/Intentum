@page "/project-pulse"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpFactory
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Project Pulse</PageTitle>

<div class="page-card">
    <h2 class="page-card h2" style="margin: 0 0 0.25rem 0;">The Pulse: Proje Yönetimi Niyet Katmanı</h2>
    <p class="subtitle">Takım olaylarından (TaskCompleted gecikmeli, PR gece, Estimate artışı, mesaj tonu) niyet çıkarımı; politika ile Warn, RequireAuth, Block.</p>

    <div class="project-pulse-controls">
        <div class="project-pulse-variants">
            <span class="project-pulse-label">Varyant:</span>
            @foreach (var v in new[] { "A", "B", "C", "D" })
            {
                <button type="button" class="btn-variant @(_selectedVariant == v ? "btn-variant--active" : "")" @onclick="() => SelectVariant(v)">
                    @v: @ProjectPulseVariants.GetLabel(v)
                </button>
            }
        </div>
        <div class="project-pulse-actions">
            <button type="button" class="btn-demo-insider" @onclick="ToggleDemo" disabled="@_toggleBusy">
                @(_running ? "Durdur" : "Demo Başlat")
            </button>
            <span class="status-pill @(_running ? "status-pill--running" : "status-pill--stopped")">
                @(_running ? "Çalışıyor" : "Durduruldu")
            </span>
            @if (_running || _events.Count > 0)
            {
                <span class="project-pulse-meta">Adım: @_events.Count / @ProjectPulseVariants.GetStepCount(_selectedVariant)</span>
            }
        </div>
    </div>
</div>

<div class="page-card">
    <h3 class="page-card h3" style="margin: 0 0 0.75rem 0;">Canlı özet (KPI)</h3>
    <div class="kpi-grid fraud-kpi-grid">
        <div class="card kpi-card kpi-card--metric">
            <span class="kpi-card__label">Adım</span>
            <span class="kpi-card__value">@_events.Count <span class="kpi-card__unit">/ @ProjectPulseVariants.GetStepCount(_selectedVariant)</span></span>
        </div>
        <div class="card kpi-card kpi-card--risk @ConfidenceClass(_lastEvent?.ConfidenceScore ?? 0)">
            <span class="kpi-card__label">Son güven</span>
            <span class="kpi-card__value">@((_lastEvent?.ConfidenceScore ?? 0).ToString("P0"))</span>
        </div>
        <div class="card kpi-card kpi-card--metric">
            <span class="kpi-card__label">Niyet</span>
            <span class="kpi-card__value kpi-card__value--text">@(_lastEvent?.IntentName ?? "—")</span>
        </div>
        <div class="card kpi-card kpi-card--metric">
            <span class="kpi-card__label">Karar</span>
            <span class="kpi-card__value kpi-card__value--text">
                @if (_lastEvent?.Decision != null)
                {
                    <span class="decision-badge decision-badge--@(_lastEvent.Decision.ToLowerInvariant())">@_lastEvent.Decision</span>
                }
                else
                {
                    <span>—</span>
                }
            </span>
        </div>
    </div>
</div>

<div class="page-card">
    <h3 class="page-card h3" style="margin: 0 0 0.75rem 0;">Grafikler</h3>
    <div class="fraud-charts-grid">
        <div class="fraud-chart-card card">
            <h3 class="fraud-chart-card__title">Güven skoru (gauge)</h3>
            <div id="project-pulse-gauge" class="fraud-gauge"></div>
        </div>
        <div class="fraud-chart-card card fraud-chart-card--wide">
            <h3 class="fraud-chart-card__title">Güven skoru adımlara göre</h3>
            <div id="project-pulse-line" class="fraud-line-chart"></div>
            @if (_events.Count == 0 && !_running)
            {
                <p class="fraud-chart-placeholder">Demo başlattığınızda grafik dolacak.</p>
            }
        </div>
    </div>
</div>

@if (_events.Count > 0)
{
    <div class="page-card">
        <h3 class="page-card h3" style="margin: 0 0 0.75rem 0;">Olaylar ve Niyet</h3>
        <ul class="project-pulse-event-list">
            @foreach (var e in _events.OrderBy(x => x.EventIndex))
            {
                <li class="project-pulse-event-item">
                    <span class="project-pulse-event-step">Adım @e.EventIndex</span>
                    <span class="project-pulse-event-summary">@(e.EventsSummary ?? "—")</span>
                    <span class="project-pulse-event-score @ConfidenceClass(e.ConfidenceScore)">@e.ConfidenceScore.ToString("P0")</span>
                    <span class="decision-badge decision-badge--@((e.Decision ?? "").ToLowerInvariant())">@(e.Decision ?? "—")</span>
                </li>
            }
        </ul>
        @if (_lastEvent is { Final: true })
        {
            <div class="project-pulse-result">
                <p><strong>Niyet:</strong> @(_lastEvent.IntentName ?? "—")</p>
                <p><strong>Karar:</strong> <span class="decision-badge decision-badge--@((_lastEvent.Decision ?? "").ToLowerInvariant())">@(_lastEvent.Decision ?? "—")</span></p>
                @if ((_lastEvent.Decision ?? "") is "Block" or "Warn" or "RequireAuth")
                {
                    <div class="insider-warn-banner">
                        @(_lastEvent.Decision == "Block" ? "Takvim bloğu önerildi (kod temizleme). Yeni özellik kartları askıya alındı." :
                          _lastEvent.Decision == "RequireAuth" ? "Yeni özellik için CTO onayı gerekli." : "Yöneticiye bildirim gönderildi.")
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    private string _selectedVariant = ProjectPulseVariants.VariantA;
    private bool _running;
    private bool _toggleBusy;
    private readonly List<ProjectPulseStreamEvent> _events = new();
    private ProjectPulseStreamEvent? _lastEvent;
    private CancellationTokenSource? _sseCts;
    private EChartsInterop? _gaugeEcharts;
    private EChartsInterop? _lineEcharts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(100);
            await InvokeAsync(async () =>
            {
                if (_gaugeEcharts != null) return;
                _gaugeEcharts = new EChartsInterop(JSRuntime, "project-pulse-gauge");
                _lineEcharts = new EChartsInterop(JSRuntime, "project-pulse-line");
                if (await _gaugeEcharts.InitAsync() && await _lineEcharts.InitAsync())
                    await UpdateProjectPulseCharts();
                StateHasChanged();
            });
        }
        else if (_gaugeEcharts != null && _lineEcharts != null)
        {
            await UpdateProjectPulseCharts();
        }
    }

    private async Task UpdateProjectPulseCharts()
    {
        await UpdateProjectPulseGauge(_lastEvent?.ConfidenceScore ?? 0);
        await UpdateProjectPulseLine();
    }

    private async Task UpdateProjectPulseGauge(double value)
    {
        if (_gaugeEcharts == null) return;
        var pct = Math.Round(value * 100, 0);
        var option = new
        {
            series = new[]
            {
                new
                {
                    type = "gauge",
                    startAngle = 180,
                    endAngle = 0,
                    min = 0,
                    max = 100,
                    progress = new { show = true, width = 18, roundCap = true },
                    detail = new { valueAnimation = true, formatter = "{value}%", offsetCenter = new[] { "0%", "75%" }, fontSize = 18, fontWeight = "bold" },
                    data = new[] { new { value = pct } },
                    axisLine = new
                    {
                        roundCap = true,
                        lineStyle = new
                        {
                            width = 18,
                            color = new object[] { new object[] { 0.3, "#4caf50" }, new object[] { 0.7, "#ff9800" }, new object[] { 1.0, "#d32f2f" } }
                        }
                    },
                    pointer = new { show = false },
                    axisTick = new { show = false },
                    splitLine = new { show = false }
                }
            }
        };
        await _gaugeEcharts.SetOptionAsync(option);
    }

    private async Task UpdateProjectPulseLine()
    {
        if (_lineEcharts == null) return;
        var ordered = _events.OrderBy(x => x.EventIndex).ToList();
        var categories = ordered.Select(e => "Adım " + e.EventIndex).ToList();
        var values = ordered.Select(e => Math.Round(e.ConfidenceScore, 4)).ToList();
        var option = new
        {
            tooltip = new { trigger = "axis", axisPointer = new { type = "shadow" } },
            grid = new { left = "3%", right = "4%", bottom = "3%", top = "8%", containLabel = true },
            xAxis = new { type = "category", data = categories, axisLine = new { show = true }, splitLine = new { show = false } },
            yAxis = new { type = "value", min = 0, max = 1, axisLine = new { show = false }, splitLine = new { lineStyle = new { type = "dashed", opacity = 0.4 } }, axisLabel = new { formatter = "{value}" } },
            series = new[]
            {
                new { type = "line", data = values, smooth = true, symbol = "circle", symbolSize = 8, lineStyle = new { width = 2 }, areaStyle = new { opacity = 0.2 } }
            }
        };
        await _lineEcharts.SetOptionAsync(option);
    }

    private void SelectVariant(string v)
    {
        if (_running) return;
        _selectedVariant = v;
        _events.Clear();
        _lastEvent = null;
        StateHasChanged();
    }

    private async Task ToggleDemo()
    {
        if (_toggleBusy) return;
        _toggleBusy = true;
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            if (_running)
            {
                await Http.PostAsync(baseUri + "/api/project-pulse/stop", null);
                _sseCts?.Cancel();
                _running = false;
            }
            else
            {
                _events.Clear();
                _lastEvent = null;
                var startReq = new ProjectPulseStartRequest(_selectedVariant);
                var res = await Http.PostAsJsonAsync(baseUri + "/api/project-pulse/start", startReq);
                if (res.IsSuccessStatusCode)
                {
                    _running = true;
                    _ = ConnectSse(baseUri);
                }
            }
        }
        catch { /* ignore */ }
        _toggleBusy = false;
        StateHasChanged();
    }

    private async Task ConnectSse(string baseUri)
    {
        _sseCts?.Cancel();
        _sseCts?.Dispose();
        _sseCts = new CancellationTokenSource();
        try
        {
            var client = HttpFactory.CreateClient("Intentum.SSE");
            using var request = new HttpRequestMessage(HttpMethod.Get, baseUri + "/api/project-pulse/stream");
            using var response = await client.SendAsync(request, HttpCompletionOption.ResponseHeadersRead, _sseCts.Token);
            response.EnsureSuccessStatusCode();
            await using var stream = await response.Content.ReadAsStreamAsync(_sseCts.Token);
            using var reader = new StreamReader(stream);
            while (!_sseCts.Token.IsCancellationRequested)
            {
                var line = await reader.ReadLineAsync(_sseCts.Token);
                if (line?.StartsWith("data: ", StringComparison.Ordinal) != true) continue;
                var json = line.Substring(6).Trim();
                if (string.IsNullOrEmpty(json)) continue;
                var ev = System.Text.Json.JsonSerializer.Deserialize<ProjectPulseStreamEvent>(json, _jsonOptions);
                if (ev == null) continue;
                if (!_events.Any(x => x.EventIndex == ev.EventIndex))
                    _events.Add(ev);
                _lastEvent = ev;
                await InvokeAsync(StateHasChanged);
                if (ev.Final) _running = false;
            }
        }
        catch (OperationCanceledException) { }
        catch (Exception) { _running = false; }
        await InvokeAsync(StateHasChanged);
    }

    private static readonly System.Text.Json.JsonSerializerOptions _jsonOptions = new() { PropertyNameCaseInsensitive = true };

    private static string ConfidenceClass(double score)
    {
        if (score >= 0.8) return "confidence-high";
        if (score >= 0.5) return "confidence-medium";
        return "confidence-low";
    }

    public async ValueTask DisposeAsync()
    {
        _sseCts?.Cancel();
        if (_running)
        {
            try
            {
                var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
                await Http.PostAsync(baseUri + "/api/project-pulse/stop", null);
            }
            catch { /* ignore */ }
        }
        if (_gaugeEcharts != null) await _gaugeEcharts.DisposeAsync();
        if (_lineEcharts != null) await _lineEcharts.DisposeAsync();
    }

    private sealed record ProjectPulseStreamEvent(
        string? Source,
        string? Variant,
        int EventIndex,
        int TotalSteps,
        string? IntentName,
        string? ConfidenceLevel,
        double ConfidenceScore,
        string? Decision,
        string? EventsSummary,
        string? RecordedAt,
        string? Reasoning,
        bool Final
    );
}
