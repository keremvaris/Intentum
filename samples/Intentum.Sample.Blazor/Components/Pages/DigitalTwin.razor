@page "/digital-twin"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Digital Twin</PageTitle>

<div class="page-card">
    <h2 class="page-card h2" style="margin: 0 0 0.25rem 0;">Oracle of Operations: Dijital İkiz Niyet Katmanı</h2>
    <p class="subtitle">Depo/üretim bileşenleri (robot hata oranı, talep spike, konveyör) → sistemik niyet; Escalate, What-If önerisi.</p>

    <div class="project-pulse-controls">
        <div class="project-pulse-variants">
            <span class="project-pulse-label">Varyant:</span>
            @foreach (var v in new[] { "A", "B", "C", "D" })
            {
                <button type="button" class="btn-variant @(_selectedVariant == v ? "btn-variant--active" : "")" @onclick="() => SelectVariant(v)">
                    @v: @DigitalTwinVariants.GetLabel(v)
                </button>
            }
        </div>
        <button type="button" class="btn-demo-insider" @onclick="RunInfer" disabled="@_running">
            @(_running ? "Çalışıyor…" : "Niyet Çıkar")
        </button>
    </div>
</div>

@if (_result != null)
{
    <div class="page-card">
        <h3 class="page-card h3" style="margin: 0 0 0.75rem 0;">Özet (KPI)</h3>
        <div class="kpi-grid fraud-kpi-grid">
            <div class="card kpi-card kpi-card--metric">
                <span class="kpi-card__label">Niyet</span>
                <span class="kpi-card__value kpi-card__value--text">@_result.IntentName</span>
            </div>
            <div class="card kpi-card kpi-card--risk @ConfidenceClass(_result.ConfidenceScore)">
                <span class="kpi-card__label">Güven</span>
                <span class="kpi-card__value">@_result.ConfidenceScore.ToString("P0")</span>
            </div>
            <div class="card kpi-card kpi-card--metric">
                <span class="kpi-card__label">Karar</span>
                <span class="kpi-card__value kpi-card__value--text">
                    <span class="decision-badge decision-badge--@(_result.Decision.ToLowerInvariant())">@_result.Decision</span>
                </span>
            </div>
            <div class="card kpi-card kpi-card--metric">
                <span class="kpi-card__label">Metrik sayısı</span>
                <span class="kpi-card__value">@(_result.EventsSummary.Count)</span>
            </div>
        </div>
    </div>
    <div class="page-card">
        <h3 class="page-card h3" style="margin: 0 0 0.75rem 0;">Güven skoru ve sistem özeti</h3>
        <div class="fraud-charts-grid">
            <div class="fraud-chart-card card">
                <h3 class="fraud-chart-card__title">Güven skoru</h3>
                <div id="digital-twin-gauge" class="fraud-gauge"></div>
            </div>
            <div class="fraud-chart-card card fraud-chart-card--wide">
                <h3 class="fraud-chart-card__title">Sistem niyeti özeti</h3>
                <div id="digital-twin-bar" class="fraud-line-chart"></div>
            </div>
        </div>
    </div>
    <div class="page-card">
        <h3 class="page-card h3" style="margin: 0 0 0.75rem 0;">Metrik olayları</h3>
        <ul class="project-pulse-event-list">
            @foreach (var s in _result.EventsSummary)
            {
                <li class="project-pulse-event-item"><span class="project-pulse-event-summary">@s</span></li>
            }
        </ul>
        <div class="project-pulse-result insider-result">
            <p><strong>Niyet:</strong> @_result.IntentName</p>
            <p><strong>Güven:</strong> @_result.ConfidenceScore.ToString("P0") (@_result.ConfidenceLevel)</p>
            <p><strong>Karar:</strong> <span class="decision-badge decision-badge--@(_result.Decision.ToLowerInvariant())">@_result.Decision</span></p>
            @if (_result.Decision == "Escalate")
            {
                <div class="insider-warn-banner">Operasyon müdürüne rapor sunuldu.</div>
            }
        </div>
        @if (!string.IsNullOrEmpty(_result.RecommendedScenario))
        {
            <div class="customer-journey-wow digital-twin-whatif">
                <h4 class="insider-echarts-title">What-If önerisi</h4>
                <p class="customer-journey-content-type">@_result.RecommendedScenario</p>
            </div>
        }
    </div>
}

@code {
    private string _selectedVariant = DigitalTwinVariants.VariantA;
    private bool _running;
    private DigitalTwinInferResult? _result;
    private EChartsInterop? _gaugeEcharts;
    private EChartsInterop? _barEcharts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_result == null) return;
        if (_gaugeEcharts == null)
        {
            await Task.Delay(100);
            await InvokeAsync(async () =>
            {
                if (_gaugeEcharts != null) return;
                _gaugeEcharts = new EChartsInterop(JSRuntime, "digital-twin-gauge");
                _barEcharts = new EChartsInterop(JSRuntime, "digital-twin-bar");
                if (await _gaugeEcharts.InitAsync() && await _barEcharts.InitAsync())
                    await UpdateDigitalTwinCharts();
                StateHasChanged();
            });
        }
        else
            await UpdateDigitalTwinCharts();
    }

    private async Task UpdateDigitalTwinCharts()
    {
        if (_result == null) return;
        if (_gaugeEcharts != null)
        {
            var pct = Math.Round(_result.ConfidenceScore * 100, 0);
            await _gaugeEcharts.SetOptionAsync(new
            {
                series = new[]
                {
                    new
                    {
                        type = "gauge",
                        startAngle = 180,
                        endAngle = 0,
                        min = 0,
                        max = 100,
                        progress = new { show = true, width = 18, roundCap = true },
                        detail = new { valueAnimation = true, formatter = "{value}%", offsetCenter = new[] { "0%", "75%" }, fontSize = 18, fontWeight = "bold" },
                        data = new[] { new { value = pct } },
                        axisLine = new { roundCap = true, lineStyle = new { width = 18, color = new object[] { new object[] { 0.3, "#4caf50" }, new object[] { 0.7, "#ff9800" }, new object[] { 1.0, "#d32f2f" } } } },
                        pointer = new { show = false },
                        axisTick = new { show = false },
                        splitLine = new { show = false }
                    }
                }
            });
        }
        if (_barEcharts != null)
        {
            var eventCount = _result.EventsSummary.Count;
            var option = new
            {
                tooltip = new { trigger = "axis" },
                grid = new { left = "3%", right = "4%", bottom = "3%", top = "8%", containLabel = true },
                xAxis = new { type = "category", data = new[] { "Güven %", "Metrik sayısı", "Escalate" }, axisLine = new { show = true }, splitLine = new { show = false } },
                yAxis = new { type = "value", min = 0, axisLine = new { show = false }, splitLine = new { lineStyle = new { type = "dashed", opacity = 0.4 } } },
                series = new[] { new { type = "bar", data = new object[] { Math.Round(_result.ConfidenceScore * 100, 0), eventCount, _result.Decision == "Escalate" ? 1 : 0 }, itemStyle = new { color = "#5c6bc0" }, barWidth = "50%" } }
            };
            await _barEcharts.SetOptionAsync(option);
        }
    }

    private static string ConfidenceClass(double score)
    {
        if (score >= 0.8) return "high";
        if (score >= 0.5) return "medium";
        return "low";
    }

    private async Task SelectVariant(string v)
    {
        if (_running) return;
        _selectedVariant = v;
        if (_gaugeEcharts != null) { await _gaugeEcharts.DisposeAsync(); _gaugeEcharts = null; }
        if (_barEcharts != null) { await _barEcharts.DisposeAsync(); _barEcharts = null; }
        _result = null;
        StateHasChanged();
    }

    private async Task RunInfer()
    {
        _running = true;
        if (_gaugeEcharts != null) { await _gaugeEcharts.DisposeAsync(); _gaugeEcharts = null; }
        if (_barEcharts != null) { await _barEcharts.DisposeAsync(); _barEcharts = null; }
        _result = null;
        StateHasChanged();
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            var req = new DigitalTwinInferRequest(_selectedVariant);
            var res = await Http.PostAsJsonAsync(baseUri + "/api/digital-twin/infer", req);
            if (res.IsSuccessStatusCode)
                _result = await res.Content.ReadFromJsonAsync<DigitalTwinInferResult>();
        }
        catch { /* ignore */ }
        _running = false;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_gaugeEcharts != null) await _gaugeEcharts.DisposeAsync();
        if (_barEcharts != null) await _barEcharts.DisposeAsync();
    }
}
