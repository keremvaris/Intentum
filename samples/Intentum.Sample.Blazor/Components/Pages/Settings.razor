@page "/settings"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Settings</PageTitle>

<div class="page-card">
    <h2 style="margin: 0 0 0.25rem 0;">Settings / Config</h2>
    <p class="subtitle" style="margin: 0;">Güven eşiği, kayan pencere, decay, provider. <InfoIcon Text="Dashboard ve analiz için kullanılan yapılandırma değerleri. Confidence threshold: karar eşiği; Sliding window: zaman penceresi (dakika); Decay factor: eski veri ağırlığı; Provider: model sağlayıcı adı." /></p>
</div>

@if (_loading)
{
    <div class="page-card"><p class="muted">Yükleniyor…</p></div>
}
else if (_error != null)
{
    <div class="page-card"><p class="error">@_error</p></div>
}
else
{
    <div class="page-card">
    <div class="card" style="max-width: 400px;">
        <form @onsubmit="Save" @onsubmit:preventDefault="true">
            <label>Confidence threshold <input type="number" step="0.01" min="0" max="1" @bind="_threshold" /></label>
            <label>Sliding window (dakika) <input type="number" min="1" @bind="_windowMinutes" /></label>
            <label>Decay factor <input type="number" step="0.01" min="0" max="1" @bind="_decayFactor" /></label>
            <label>Provider <input type="text" @bind="_provider" placeholder="Local / OpenAI" /></label>
            <button type="submit">Kaydet</button>
            <button type="button" @onclick="Reset">Varsayılana dön</button>
            @if (_savedMessage)
            {
                <p class="success-msg">Kaydedildi.</p>
            }
        </form>
    </div>
    </div>
}

@code {
    private bool _loading = true;
    private string? _error;
    private bool _savedMessage;
    private double _threshold = 0.6;
    private int _windowMinutes = 60;
    private double _decayFactor = 0.95;
    private string _provider = "Local";

    protected override async Task OnInitializedAsync()
    {
        await LoadConfig();
    }

    private async Task LoadConfig()
    {
        _loading = true;
        _error = null;
        StateHasChanged();
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            var config = await Http.GetFromJsonAsync<ConfigDto>(baseUri + "/api/dashboard/config");
            if (config != null)
            {
                _threshold = config.ConfidenceThreshold;
                _windowMinutes = config.SlidingWindowMinutes;
                _decayFactor = config.DecayFactor;
                _provider = config.Provider ?? "Local";
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task Save()
    {
        _error = null;
        _savedMessage = false;
        try
        {
            var baseUri = new Uri(Navigation.BaseUri).GetLeftPart(UriPartial.Authority);
            var body = new { ConfidenceThreshold = _threshold, SlidingWindowMinutes = _windowMinutes, DecayFactor = _decayFactor, Provider = _provider };
            await Http.PutAsJsonAsync(baseUri + "/api/dashboard/config", body);
            _savedMessage = true;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        StateHasChanged();
    }

    private void Reset()
    {
        _threshold = 0.6;
        _windowMinutes = 60;
        _decayFactor = 0.95;
        _provider = "Local";
        StateHasChanged();
    }

    private sealed record ConfigDto(double ConfidenceThreshold, int SlidingWindowMinutes, double DecayFactor, string? Provider);
}
